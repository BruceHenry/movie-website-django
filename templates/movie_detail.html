{% extends "base.html" %}
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'css/user-profile.css' %}"/>

{% block mainbody %}

<div class="Layer" id="layer"></div>
    <div class="container" id='movie_info'>
        {% if object %}
            
            <div id="detail-infro">
                <h1>{{ object.title }}</h1>

                 <div class="rating">
                            <input type="radio" name="rating" value="5" id="5">
                            <label for="5">☆</label>
                            <input type="radio" name="rating" value="4" id="4">
                            <label for="4">☆</label>
                            <input type="radio" name="rating" value="3" id="3">
                            <label for="3">☆</label>
                            <input type="radio" name="rating" value="2" id="2">
                            <label for="2">☆</label>
                            <input type="radio" name="rating" value="1" id="1">
                            <label for="1">☆</label>
                     <script>
                         var rated = {{ object.rate }} ;
                         var movieid = '{{object.movieid}}';
                         console.log(movieid);
                         var username = '{{ user.username }}';
                         console.log(username);
                         user_rate_movie = {{ rate_score }};
                         if(user_rate_movie==0){
                             var stars = Math.floor(rated/2);
                             input_value = '#' + stars.toString();
                             console.log(input_value);
                             $(input_value).attr('checked', 'checked');
                         }
                         else{
                             input_value = '#' + user_rate_movie.toString();
                             console.log(input_value);
                             $(input_value).attr('checked', 'checked');
                         }

                         $("input[name='rating']").click(function() {
                             var radioValue = $("input[name='rating']:checked").val();
                             console.log(radioValue);
                             if (radioValue) {
                                 console.log('send mess !');
                                 $.ajax({
                                   url : "{% url 'rate-movie' %}",
                                   type: 'POST',
                                   datatype: 'json',
                                   processData: "application/json",
                                   data: {
                                   movieid: movieid,
                                   type: 'rate',
                                   username : username,
                                   rate_score : radioValue,
                                    },
                                     //beforeSend:function (xhr,settings) {
                                    //console.log("{{ csrf_token }}");
                                    //xhr.setRequestHeader("X-CSRFToken","{{ csrf_token }}");
                                    //},
                                    }).done(function (data) {
                                     if (data.type == 'error') {
                                         alert('erorr !');
                                         Swal.fire('Any fool can use a computer')
                                         Swal.fire({
                                             icon: 'error',
                                             title: 'Oops...',
                                             text: 'Something went wrong!',
                                             footer: '<a href>Why do I have this issue?</a>'
                                         })
                                     } else {
                                         Swal.fire(
                                             'Good job!',
                                             'You rated this movie!',
                                             'success'
                                         );
                                         console.log(data);
                                     }
                                 });
                             }
                         });

                     </script>

                </div>

                {% if  user.is_authenticated %}
                    <button class="add_button" id="seen">Have seen</button>
                    <button class="add_button" id="expect">Want to see</button>
                    <b style="color: #f44336" id="message"></b>
                    {% if  object.flag == 1 %}
                        <script>
                            $("#seen").css({"background-color": "#f44336", "color": "white"});
                        </script>
                    {% endif %}
                    {% if  object.flag == 2 %}
                        <script>
                            $("#expect").css({"background-color": "#f44336", "color": "white"});
                        </script>
                    {% endif %}
                {% endif %}

                <script>
                    $(document).ready(function () {
                        $("#seen").click(function () {
                            $.get("/movie/add_seen/{{ object.movieid }}", function (msg) {
                                if (msg == "1") {
                                    $("#seen").css({"background-color": "#f44336", "color": "white"});
                                    $("#expect").css({"background-color": "white", "color": "black"});
                                    $("#message").html("Added to Seen list!").fadeIn("fast").fadeOut("slow");
                                }
                                if (msg == "0") {
                                    $("#seen").css({"background-color": "white", "color": "black"});
                                    $("#message").html("Deleted from Seen list!").fadeIn("fast").fadeOut("slow");
                                }
                            });
                        });


                    });
                </script>
                <script>
                    $(document).ready(function () {
                        $("#expect").click(function () {
                            $.get("/movie/add_expect/{{ object.movieid }}", function (msg) {
                                if (msg == "2") {
                                    $("#expect").css({"background-color": "#f44336", "color": "white"});
                                    $("#seen").css({"background-color": "white", "color": "black"});
                                    $("#message").html("Added to Wish list!").fadeIn("fast").fadeOut("slow");
                                }
                                if (msg == "0") {
                                    $("#expect").css({"background-color": "white", "color": "black"});
                                    $("#message").html("Deleted from Wish list!").fadeIn("fast").fadeOut("slow");
                                }
                            });
                        });
                    });
                </script>

                <div class="movie-detail box">

                    <p><b>Year:</b> {{ object.year }}</p>
                    <p><b>Genres:</b> {{ object.genres }}</p>
                    <p><b>Movie Length:</b> {{ object.length }} min</p>
                    <p><b>IMDB:</b> {{ object.rate }}</p>
                    <p><a href="http://www.imdb.com/title/{{ object.movieid }}" target="_blank">See in IMDB <span
                            class="glyphicon glyphicon-new-window"></span></a></p>
                    <span class="click_Show"> <button class="button_trailer">
                    <span class="glyphicon glyphicon-play-circle"></span> Trailer</button>
                    </span>

                    <div id="TrailerWindow" style="position: fixed;">
                        <div id="title">{{ object.title }}
                            <button type="button" class="close" aria-label="Close">
                                <span aria-hidden="true">x</span>
                            </button>
                        </div>
                        <div id="videoControl">
                            <iframe width="560" height="500" src="https://www.youtube.com/embed/{{ object.youtubeid }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    </div>

                    <p id="summary"><b>Plot Summary: </b>"{{ object.plot }}"</p>

                    <p><b>Main actors : </b></p>

                    {% for item in items %}
                        <a href="/movie/actor_detail/{{ item.actorid }}" target="_self">{{ item.name }}</a>
                    {% endfor %}
                    <br>
                    <br>
                    <p><b>Add tag for {{object.title}}</b></p> 
                    <div class="input-group mb-3" id="addTagClass">
                      <input type="text" id="nameTag"  placeholder="Add your tags..." style="width: 100px" aria-label="Recipient's username" aria-describedby="basic-addon2">
                      <div class="input-group-btn">
                        <button class="btn btn-secondary" onclick="addTag()" type="button">+</button>
                      </div>
                    </div>

                    <p><b>Your Tags : </b></p>
                    {% for tag in users_tags %}
                        <a type="text" class="w-25 p-3"> {{tag.tags}} </a>
                    {% endfor %}





                    <script>
                        function addTag(){

                            var movieid = '{{object.movieid}}';
                            var username = '{{ user.username }}';
                            {#console.log(username);#}
                            {#console.log(movieid);#}
                            var nameTag = $('#nameTag').val();
                            {#console.log(nameTag);#}

                            //send ajax
                            $.ajax({
                                   url : "{% url 'add-tag' %}",
                                   type: 'POST',
                                   datatype: 'json',
                                   processData: "application/json",
                                   data: {
                                   movieid: movieid,
                                   type: 'add-tag',
                                   username : username,
                                   tag : nameTag
                                    }
                                    }).done(function (data) {
                                if (data.mess == 'error') {
                                    Swal.fire('You have tagged this movie already')
                                } else {
                                    Swal.fire(
                                      'Good job!',
                                      'You clicked the button!',
                                      'success'
                                    )
                                    $('#nameTag').val('');
                                    console.log(data);

                                    $('#addTagClass').append(
                                                            '<div class="input-group ">' +
                                                            '<div class="input-group-prepend">'+
                                                            '<button class="btn btn-outline-secondary" >' + 'x'+ data.count +
                                                            '</button>' +
                                                            '</div>' +
                                                            '<button class="w-10 p-2"  aria-describedby="basic-addon2">' +data.tags + '</button>' +
                                                            '<div class="input-group-append">' +
                                                            '<button class="btn btn-outline-secondary" type="button">' + '+' + '</button>'+
                                                            '</div>'+
                                                            '</div>');

                                }
                            })
                        }
                    </script>

                    <p><b>Tags Comunity : </b></p>
                    {% if dict_tags %}
                        <div class="input-group ">
                                {% for tag,count in dict_tags.items %}
                                    {% if count > 10 %}
                                        <div class="input-group-prepend">
                                        <button class="btn btn-outline-secondary" >{{ count }}</button>
                                        </div>
                                        <button class="w-5 p-1"  aria-describedby="basic-addon2">{{ tag }} </button>

                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary" type="button">+</button>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                        </div>
                    {% endif %}

                </div>
            </div>

            <div id="main-pic">
                <img border="0" src="{{ object.poster }}" alt="Cannot load photo, sorry!" style = "position: absolute;left: 240px; top: 150px" width="300" height="500">
            </div>

        {% endif %}
        </div>
    {% if user.is_authenticated %}
    <div class="container" name = "reviews">
    <div class="card-user-profile">
        <div class="profile-page-center">
            <h3 class="card-user-profile-name"> COMMUNITY REVIEWS</h3>
                <div class="comment-block">
                            <div id="form-comment" class="form-group">
                                <textarea class="form-control" id="review-textarea" rows="2" placeholder="Say something for {{profile.user}}..."></textarea>
                                <div class="media-feed-control clearfix">
                                    <button onclick="review()" type="button" class="btn btn-secondary btn-sm comment-reply float-right waves-effect waves-light">Post</button>
                                </div>
                            </div>
                </div>
                <hr>
                <ul class="list-unstyled mt-5">
                        {% for review in reviews %}
                            <li class="media">
                                <div class="profile-picture">
                                    <img src="{{review.user.profile.profile_picture.url}}" width="44" height="44">
                                </div>
                                <div class="media-body">
                                    <div class="media-title mt-0 mb-1">
                                        <a href="{{review.user.profile.get_absolute_url}}">{{ review.user.username }}</a> <small> {{ review.get_date }}</small>
                                    </div>
                                    {{ review.review }}
                                    <div class="media-feed-control">
                                        <a href="" id="likeButton">
                                            <input type="hidden" name="likePostID" value="{{ review.id }}">
                                            {% if review.total_likes > 0 %}
                                                <i class="batch-icon batch-icon-heart-full" ></i> Like <span id="count-likes{{ review.id }}"> {{review.total_likes}} </span>
                                            {% else %}
                                                <i class="batch-icon batch-icon-heart-full" ></i> Like <span id="count-likes{{ review.id }}"></span>

                                            {% endif %}
                                        </a>
                                        <a href="#">
                                            {% if review.total_reply > 0 %}
                                                <i class="batch-icon batch-icon-speech-bubble-left-tip"></i> Comment <span id="count-comments{{ review.id }}"> {{review.total_reply}} </span>
                                            {% else %}
                                                <i class="batch-icon batch-icon-speech-bubble-left-tip"></i> Comment <span id="count-comments{{ review.id }}"> </span>
                                            {% endif %}

                                        </a>
                                    </div>
                                    <div class="media-body-reply-block">
                                        <ul class="list-unstyled">
                                            {% for reply  in review.get_all_reply %}
                                                <li class="media mt-4">
                                                    <div class="profile-picture bg-gradient bg-primary mb-4">
                                                        <img src="{{reply.user.profile.profile_picture.url}}" width="44" height="44">
                                                    </div>
                                                    <div class="media-body">
                                                        <div class="media-title mt-0 mb-1">
                                                            <a href="{{ reply.user.profile.get_absolute_url }}">{{ reply.user.username }}</a> <small> {{ reply.get_date }}</small>
                                                        </div>
                                                        {{reply.content}}
                                                    </div>
                                                <li>
                                            {% endfor %}
                                            <li class="comment-reply-block mt-4">
                                                <form method="POST" class="form-reply" enctype="multipart/form-data">
                                                    <input type="hidden" class="replyID" name="postID" value="{{ review.id }}">
                                                    <textarea class="form-control comment-reply-textarea" name="content" rows="2" placeholder="reply review here..."> </textarea>
                                                    <button type="submit" class="btn btn-secondary btn-sm comment-reply float-right waves-effect waves-light"> Reply </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </div>          
                            </li>
                        {% endfor %}
                    </ul>
        </div>
    </div> 
    </div> 
    {% endif %} 


    
<script>

$(document).on('submit', '.form-reply', function (event){
                event.preventDefault();
                //remember the form element
                var $form = $(this);

                // get dom by name
                var $content = $form.find("textarea[name='content']");
                // get dome by id
                var $postID = $form.find(".postID");

                var content =  $form.find("textarea[name='content']").val();
                var postID =   $form.find("input[name='postID']").val();

                console.log(content);
                console.log(postID);

                // now do ajax
                $.ajax({
                url: "{% url 'reply-review' %}",
                type: 'POST',
                datatype: 'json',
                processData: "application/json",
                data: {
                    content: content,
                    postID: postID,
                    type: 'reply',
                },
                
            }).done(function (data){
                $content.val('');
                console.log(data);
                $form.parent().prepend( '<div class="media-title mt-0 mb-1">' +
                    '<a href="' + data.send_user_url + ' ">' + data.send_user  + '</a>' + ' ' +  '<small>'  + data.date_posted + '</small>' +
                    '</div>' + data.content   );

                var countCommentID = '#count-comments' + data.review_id;
                var count =  $(countCommentID).text();
                $(countCommentID).html(parseInt(count) +1);

                {#location.reload();#}
            });
            });

function review(){
        var content = $('#review-textarea').val();
        var movieid = '{{object.movieid}}';
        var username = '{{ user.username }}';
            console.log(content);

            if (content == '') {
                Swal.fire('Comments cannot be empty');
                return
            }
            $.ajax({
                type: "POST",
                // bo sung dau gach cheo moi duoc
                url: "{% url 'review-movie' %}",
                data: {content: content, type : 'review', movieid: movieid, 'username':username},
                processData: "application/json",
                dataType: "json",

            }).done(function (data) {
                console.log(data);
                location.reload();

            });

        };
$(document).on('click', '#likeButton', function (event) {
                event.preventDefault();
                var postID  = $(this).find("input[name='likePostID']").val();
                var likeID = '#count-likes' + postID

                $.ajax({
                    url : "{% url 'like-review'%}",
                    type: 'POST',
                    datatype: 'json',
                    processData: "application/json",
                    data: {
                    postID: postID,
                    type: 'like',
                    status : 'True',
                },
            }).done(function (data) {
                    if(data.type==-1){
                        alert('erorr !');
                    }
                    else {
                        // why with 1 id , count not run !!
                        console.log(data.count_likes);
                        if(data.count_likes == 0){
                            $(likeID).text('');
                        }
                        else{
                            $(likeID).text(data.count_likes);
                        }
                    }


                });
});


</script>
<script type="text/javascript">
            function layersize() {
                document.getElementById("layer").style.width = document.documentElement.scrollWidth + "px";
                document.getElementById("layer").style.height = document.documentElement.scrollHeight + "px";
            }

            $(".click_Show").click(function () {
                layersize();
                $(".Layer").show();//show layer
                $("#TrailerWindow").show();//show videoWindow
                tm();
            });

            $(window).resize(function () {
                layersize();
                tm();
            });

            function tm() {
                var _left = (document.documentElement.clientWidth - $("#TrailerWindow").width()) / 2;//Get distance of left
                var _top = (document.documentElement.clientHeight) * 0.15;//Get distance of top
                $("#TrailerWindow").css({left: _left, top: _top});
            }

            $("button.close").click(function () {
                $('video').trigger('pause');
                $("#TrailerWindow").hide();//hide
                $(".Layer").hide();//hide
            });
</script>
    


{% endblock %}
